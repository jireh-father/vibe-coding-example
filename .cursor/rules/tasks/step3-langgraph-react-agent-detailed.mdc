---
description: 
globs: 
alwaysApply: false
---
# 3ë‹¨ê³„: LangGraph React Agent ê¸°ë³¸ ì›Œí¬í”Œë¡œìš° êµ¬í˜„

## ğŸ¯ ëª©í‘œ
- **LangGraphì˜ create_react_agent** ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©
- **langchain-mcp-adapters**ë¥¼ í†µí•œ ê¸°ì¡´ MCP ì„œë²„ ì—°ë™
- **Gemini 2.5 Flash LLM** ì—°ë™
- **ìµœì €ê°€ ì‡¼í•‘ ì „ìš© í”„ë¡¬í”„íŠ¸** ì‘ì„±

## ğŸ“‹ ê°œë°œ ìˆœì„œ (TDD ê¸°ë°˜)

### 1. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± (Red)
```python
# tests/test_backend/test_agents/test_shopping_agent.py
```

### 2. create_react_agent + MCP Adapters êµ¬í˜„ (Green)
```python
# backend/agents/shopping_agent.py
# backend/agents/prompts/shopping_prompts.py
```

### 3. ê¸°ì¡´ MCP ì„œë²„ ì—°ë™ (Green)
```python
# backend/agents/config/mcp_config.py
```

### 4. ë¦¬íŒ©í† ë§ ë° ìµœì í™” (Refactor)

### 5. Pylint ê²€ì‚¬ ë° ìˆ˜ì •

## ğŸ”§ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### A. langchain-mcp-adapters ê¸°ë°˜ êµ¬ì¡°

#### 1. ì˜ì¡´ì„± ì„¤ì¹˜
```bash
pip install langchain-mcp-adapters langgraph "langchain[google-genai]"
```

#### 2. ê¸°ì¡´ MCP ì„œë²„ í™œìš©
```python
from langchain_mcp_adapters.client import MultiServerMCPClient
from langgraph.prebuilt import create_react_agent
from langchain_google_genai import ChatGoogleGenerativeAI

# Gemini 2.5 Flash ëª¨ë¸ ì´ˆê¸°í™”
model = ChatGoogleGenerativeAI(
    model="gemini-2.0-flash-exp",
    temperature=0.1
)

# ê¸°ì¡´ MCP ì„œë²„ë“¤ ì—°ë™
client = MultiServerMCPClient({
    "web_search": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-web-search"],
        "transport": "stdio",
        "env": {
            "BRAVE_API_KEY": "your-brave-api-key"  # ë˜ëŠ” ë‹¤ë¥¸ ê²€ìƒ‰ API
        }
    },
    "browser": {
        "command": "npx", 
        "args": ["-y", "@modelcontextprotocol/server-puppeteer"],
        "transport": "stdio",
    },
    "filesystem": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
        "transport": "stdio",
    }
})

# MCP ë„êµ¬ ë¡œë“œ
tools = await client.get_tools()

# React Agent ìƒì„±
agent = create_react_agent(
    model=model,
    tools=tools,
    prompt=SHOPPING_SYSTEM_PROMPT
)
```

#### 3. ìµœì €ê°€ ì‡¼í•‘ ì „ìš© í”„ë¡¬í”„íŠ¸
```python
SHOPPING_SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ìµœì €ê°€ ì‡¼í•‘ ì „ë¬¸ AI Assistantì…ë‹ˆë‹¤.

ì£¼ìš” ì—­í• :
1. ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ìƒí’ˆì„ ì •í™•íˆ íŒŒì•…
2. ë‹¤ì–‘í•œ ì‡¼í•‘ëª°ì—ì„œ ê°€ê²© ì •ë³´ ìˆ˜ì§‘  
3. ê°€ê²© ë¹„êµ ë° ìµœì €ê°€ ìƒí’ˆ ì¶”ì²œ
4. ìƒí’ˆ ìƒì„¸ ì •ë³´ ë° ë¦¬ë·° ìš”ì•½ ì œê³µ

ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬:
- web_search: ì›¹ ê²€ìƒ‰ (ìƒí’ˆ ê²€ìƒ‰, ê°€ê²© ì •ë³´ ìˆ˜ì§‘)
- browser: ì›¹ í˜ì´ì§€ ì ‘ê·¼ ë° ì •ë³´ ì¶”ì¶œ
- filesystem: ì„ì‹œ ë°ì´í„° ì €ì¥ ë° ê´€ë¦¬

ê²€ìƒ‰ ì „ëµ:
1. ë¨¼ì € "{ìƒí’ˆëª…} ìµœì €ê°€" í‚¤ì›Œë“œë¡œ ì›¹ ê²€ìƒ‰
2. ì£¼ìš” ì‡¼í•‘ëª°ë³„ ê²€ìƒ‰: "ë„¤ì´ë²„ì‡¼í•‘ {ìƒí’ˆëª…}", "ì¿ íŒ¡ {ìƒí’ˆëª…}", "11ë²ˆê°€ {ìƒí’ˆëª…}"
3. ë¸Œë¼ìš°ì €ë¡œ ìƒì„¸ í˜ì´ì§€ ì ‘ê·¼í•˜ì—¬ ì •í™•í•œ ê°€ê²© ì •ë³´ ìˆ˜ì§‘
4. ê°€ê²© ë¹„êµ ë° ìµœì  ìƒí’ˆ ì„ ë³„

ì‘ë‹µ í˜•ì‹:
1. ê²€ìƒ‰ëœ ìƒí’ˆ ìš”ì•½
2. ìµœì €ê°€ TOP 3 ì¶”ì²œ (ê°€ê²©, íŒë§¤ì, ë°°ì†¡ì •ë³´ í¬í•¨)
3. ì£¼ìš” íŠ¹ì§• ë° ë¦¬ë·° ìš”ì•½
4. êµ¬ë§¤ ì‹œ ì£¼ì˜ì‚¬í•­

ì£¼ì˜ì‚¬í•­:
- ì •í™•í•œ ê°€ê²© ì •ë³´ í™•ì¸ì„ ìœ„í•´ ë°˜ë“œì‹œ ë¸Œë¼ìš°ì € ë„êµ¬ í™œìš©
- í• ì¸ê°€ì™€ ì •ê°€ë¥¼ ëª…í™•íˆ êµ¬ë¶„
- ë°°ì†¡ë¹„ í¬í•¨ ìµœì¢… ê°€ê²©ìœ¼ë¡œ ë¹„êµ
- ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŒë§¤ì ìš°ì„  ì¶”ì²œ
"""
```

### B. ê°„ì†Œí™”ëœ íŒŒì¼ êµ¬ì¡°

```
backend/agents/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ shopping_agent.py           # create_react_agent + MCP Adapters
â”œâ”€â”€ prompts/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ shopping_prompts.py     # ì‡¼í•‘ ì „ìš© í”„ë¡¬í”„íŠ¸
â””â”€â”€ config/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ mcp_config.py          # ê¸°ì¡´ MCP ì„œë²„ ì„¤ì •
```

### C. ê¸°ì¡´ MCP ì„œë²„ í™œìš©

#### 1. ì›¹ ê²€ìƒ‰ MCP ì„œë²„
- **@modelcontextprotocol/server-web-search** ì‚¬ìš©
- Brave Search API ë˜ëŠ” Google Search API ì—°ë™
- ìƒí’ˆ ê²€ìƒ‰ ë° ê°€ê²© ì •ë³´ ìˆ˜ì§‘

#### 2. ë¸Œë¼ìš°ì € MCP ì„œë²„  
- **@modelcontextprotocol/server-puppeteer** ì‚¬ìš©
- ì‡¼í•‘ëª° í˜ì´ì§€ ì§ì ‘ ì ‘ê·¼
- ì •í™•í•œ ê°€ê²© ì •ë³´ ë° ìƒí’ˆ ìƒì„¸ ì •ë³´ ì¶”ì¶œ

#### 3. íŒŒì¼ì‹œìŠ¤í…œ MCP ì„œë²„
- **@modelcontextprotocol/server-filesystem** ì‚¬ìš©
- ê²€ìƒ‰ ê²°ê³¼ ì„ì‹œ ì €ì¥
- ê°€ê²© ë¹„êµ ë°ì´í„° ê´€ë¦¬

### D. ë©”ì¸ Agent êµ¬í˜„

```python
# backend/agents/shopping_agent.py
from typing import Optional, Dict
from langgraph.prebuilt import create_react_agent
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_mcp_adapters.client import MultiServerMCPClient
from .prompts.shopping_prompts import SHOPPING_SYSTEM_PROMPT
from .config.mcp_config import MCP_SERVER_CONFIG

class ShoppingReactAgent:
    """ìµœì €ê°€ ì‡¼í•‘ React Agent (ê¸°ì¡´ MCP ì„œë²„ í™œìš©)"""
    
    def __init__(self, google_api_key: str, brave_api_key: Optional[str] = None):
        self.model = ChatGoogleGenerativeAI(
            model="gemini-2.0-flash-exp",
            temperature=0.1,
            google_api_key=google_api_key
        )
        self.brave_api_key = brave_api_key
        self.client = None
        self.agent = None
        
    async def initialize(self):
        """Agent ì´ˆê¸°í™” ë° MCP ë„êµ¬ ë¡œë“œ"""
        # MCP ì„œë²„ ì„¤ì •ì— API í‚¤ ì¶”ê°€
        config = MCP_SERVER_CONFIG.copy()
        if self.brave_api_key:
            config["web_search"]["env"] = {"BRAVE_API_KEY": self.brave_api_key}
        
        # MultiServerMCPClient ì´ˆê¸°í™”
        self.client = MultiServerMCPClient(config)
        
        # MCP ë„êµ¬ ë¡œë“œ
        tools = await self.client.get_tools()
        
        # React Agent ìƒì„±
        self.agent = create_react_agent(
            model=self.model,
            tools=tools,
            prompt=SHOPPING_SYSTEM_PROMPT
        )
        
    async def search_products(self, query: str) -> Dict:
        """ìƒí’ˆ ê²€ìƒ‰ ì‹¤í–‰"""
        if not self.agent:
            await self.initialize()
            
        response = await self.agent.ainvoke({
            "messages": [("user", f"ë‹¤ìŒ ìƒí’ˆì˜ ìµœì €ê°€ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”: {query}")]
        })
        
        return {
            "query": query,
            "response": response["messages"][-1].content,
            "full_messages": response["messages"]
        }
        
    async def compare_and_recommend(self, query: str, budget: Optional[int] = None) -> Dict:
        """ê°€ê²© ë¹„êµ ë° ì¶”ì²œ"""
        if not self.agent:
            await self.initialize()
            
        budget_text = f" (ì˜ˆì‚°: {budget:,}ì›)" if budget else ""
        prompt = f"ë‹¤ìŒ ìƒí’ˆì„ ê²€ìƒ‰í•˜ê³  ê°€ê²©ì„ ë¹„êµí•˜ì—¬ ìµœì ì˜ ìƒí’ˆì„ ì¶”ì²œí•´ì£¼ì„¸ìš”: {query}{budget_text}"
        
        response = await self.agent.ainvoke({
            "messages": [("user", prompt)]
        })
        
        return {
            "query": query,
            "budget": budget,
            "recommendation": response["messages"][-1].content,
            "full_messages": response["messages"]
        }
        
    async def analyze_product_reviews(self, query: str) -> Dict:
        """ìƒí’ˆ ë¦¬ë·° ë¶„ì„"""
        if not self.agent:
            await self.initialize()
            
        prompt = f"ë‹¤ìŒ ìƒí’ˆì˜ ë¦¬ë·°ë¥¼ ë¶„ì„í•˜ì—¬ ì¥ë‹¨ì ì„ ì •ë¦¬í•´ì£¼ì„¸ìš”: {query}"
        
        response = await self.agent.ainvoke({
            "messages": [("user", prompt)]
        })
        
        return {
            "query": query,
            "analysis": response["messages"][-1].content,
            "full_messages": response["messages"]
        }
        
    async def cleanup(self):
        """ë¦¬ì†ŒìŠ¤ ì •ë¦¬"""
        if self.client:
            # MCP í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬ (í•„ìš”ì‹œ)
            pass
```

### E. MCP ì„œë²„ ì„¤ì •

```python
# backend/agents/config/mcp_config.py
import os

MCP_SERVER_CONFIG = {
    "web_search": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-web-search"],
        "transport": "stdio",
        # envëŠ” ëŸ°íƒ€ì„ì— ì¶”ê°€ë¨
    },
    "browser": {
        "command": "npx", 
        "args": ["-y", "@modelcontextprotocol/server-puppeteer"],
        "transport": "stdio",
    },
    "filesystem": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp/shopping_data"],
        "transport": "stdio",
    }
}

# ê°œë°œ í™˜ê²½ë³„ ì„¤ì •
if os.getenv("ENVIRONMENT") == "development":
    # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë¡œì»¬ MCP ì„œë²„ ì‚¬ìš© ê°€ëŠ¥
    pass
elif os.getenv("ENVIRONMENT") == "production":
    # í”„ë¡œë•ì…˜ í™˜ê²½ ìµœì í™”
    MCP_SERVER_CONFIG["filesystem"]["args"][-1] = "/var/tmp/shopping_data"
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```python
# tests/test_backend/test_agents/test_shopping_agent.py
import pytest
from unittest.mock import AsyncMock, patch
from backend.agents.shopping_agent import ShoppingReactAgent

@pytest.mark.asyncio
async def test_agent_initialization():
    """Agent ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸"""
    agent = ShoppingReactAgent("test-api-key", "test-brave-key")
    
    with patch('langchain_mcp_adapters.client.MultiServerMCPClient') as mock_client:
        mock_client.return_value.get_tools = AsyncMock(return_value=[])
        await agent.initialize()
        assert agent.agent is not None

@pytest.mark.asyncio  
async def test_product_search():
    """ìƒí’ˆ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸"""
    agent = ShoppingReactAgent("test-api-key")
    
    with patch.object(agent, 'agent') as mock_agent:
        mock_agent.ainvoke = AsyncMock(return_value={
            "messages": [{"content": "í…ŒìŠ¤íŠ¸ ì‘ë‹µ"}]
        })
        
        result = await agent.search_products("ì•„ì´í° 15")
        assert result["query"] == "ì•„ì´í° 15"
        assert "response" in result

@pytest.mark.asyncio
async def test_mcp_tools_integration():
    """ê¸°ì¡´ MCP ì„œë²„ ì—°ë™ í…ŒìŠ¤íŠ¸"""
    from langchain_mcp_adapters.client import MultiServerMCPClient
    
    # ì‹¤ì œ MCP ì„œë²„ ì—†ì´ í…ŒìŠ¤íŠ¸
    with patch('subprocess.Popen'):
        client = MultiServerMCPClient({
            "web_search": {
                "command": "echo",
                "args": ["test"],
                "transport": "stdio"
            }
        })
        # ë„êµ¬ ë¡œë”© í…ŒìŠ¤íŠ¸ ë¡œì§
```

### 2. í†µí•© í…ŒìŠ¤íŠ¸
- create_react_agent + ê¸°ì¡´ MCP ì„œë²„ ì›Œí¬í”Œë¡œìš°
- ì›¹ ê²€ìƒ‰ â†’ ë¸Œë¼ìš°ì € ì ‘ê·¼ â†’ ê°€ê²© ë¹„êµ ì „ì²´ í”Œë¡œìš°
- ì‹¤ì œ ì‡¼í•‘ëª° ë°ì´í„° ê²€ìƒ‰ í…ŒìŠ¤íŠ¸

## ğŸ“ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: MCP Adapters ê¸°ë³¸ êµ¬ì¡°
- [ ] langchain-mcp-adapters ì„¤ì¹˜ ë° ì„¤ì •
- [ ] ê¸°ì¡´ MCP ì„œë²„ ì—°ë™ ì„¤ì •
- [ ] ê¸°ë³¸ ShoppingReactAgent í´ë˜ìŠ¤ êµ¬í˜„
- [ ] ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì‘ì„±

### Phase 2: ê¸°ì¡´ MCP ì„œë²„ ì—°ë™
- [ ] @modelcontextprotocol/server-web-search ì—°ë™
- [ ] @modelcontextprotocol/server-puppeteer ì—°ë™  
- [ ] @modelcontextprotocol/server-filesystem ì—°ë™
- [ ] MCP ë„êµ¬ í…ŒìŠ¤íŠ¸

### Phase 3: Agent í†µí•©
- [ ] create_react_agent + MCP ë„êµ¬ ì—°ë™
- [ ] ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ êµ¬í˜„
- [ ] ì„±ëŠ¥ ìµœì í™”

### Phase 4: ìµœì í™” ë° í…ŒìŠ¤íŠ¸
- [ ] E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- [ ] MCP ì„œë²„ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸
- [ ] Pylint ê²€ì‚¬ ë° ìˆ˜ì •
- [ ] ë¬¸ì„œí™” ì™„ë£Œ

## ğŸš€ ì‹¤í–‰ ì˜ˆì‹œ

```python
# ì‚¬ìš© ì˜ˆì‹œ
agent = ShoppingReactAgent(
    google_api_key="your-google-api-key",
    brave_api_key="your-brave-api-key"  # ì„ íƒì‚¬í•­
)
await agent.initialize()

# ê¸°ë³¸ ê²€ìƒ‰
response = await agent.search_products("ì•„ì´í° 15 Pro 256GB")
print(response["response"])

# ì˜ˆì‚° ê¸°ë°˜ ì¶”ì²œ
recommendation = await agent.compare_and_recommend("ë…¸íŠ¸ë¶", budget=1000000)
print(recommendation["recommendation"])

# ë¦¬ë·° ë¶„ì„
review_analysis = await agent.analyze_product_reviews("ì‚¼ì„± ê°¤ëŸ­ì‹œ S24")
print(review_analysis["analysis"])

# ë¦¬ì†ŒìŠ¤ ì •ë¦¬
await agent.cleanup()
```





